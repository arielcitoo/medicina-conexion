<!-- prelogin.html -->
<div class="prelogin-container">
  <mat-card class="card-prelogin">
    <!-- Encabezado -->
    <mat-card-header class="card-header">
      <mat-card-title>
        <div class="title-container">
          <mat-icon class="title-icon">medical_services</mat-icon>
          <div>
            <h1>Acceso al Registro de Ex√°menes Preocupacionales</h1>
            <p class="subtitle">Verificaci√≥n de Empresa Afiliada a la Caja Nacional de Salud</p>
          </div>
        </div>
      </mat-card-title>
    </mat-card-header>

    <!-- Contenido Principal -->
    <mat-card-content class="card-content">
      <!-- Secci√≥n de b√∫squeda -->
      <div class="search-section">
        <div class="section-title">
          <mat-icon>business</mat-icon>
          <h2>Ingreso de Empresa</h2>
        </div>
        
        <p class="section-description">
          Ingrese el n√∫mero patronal de su empresa para verificar su afiliaci√≥n al CNS 
          y acceder al registro de ex√°menes preocupacionales.
        </p>

        <form [formGroup]="preloginForm" (ngSubmit)="onSubmit()">
          <!-- Campo de n√∫mero patronal -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>N√∫mero Patronal</mat-label>
            <input matInput 
                   formControlName="numeroPatronal"
                   placeholder="Ej: 01-730-00001"
                   [maxlength]="12"
                   (keypress)="onKeyPress($event)"
                   (input)="onInput($event)"
                   (blur)="onBlur()">
            <mat-icon matSuffix>format_list_numbered_rtl</mat-icon>
            
            <!-- Errores de validaci√≥n -->
            @if (tieneError('numeroPatronal', 'required')) {
              <mat-error>El n√∫mero patronal es obligatorio</mat-error>
            }
            @if (tieneError('numeroPatronal', 'pattern')) {
              <mat-error>Formato: 01-730-00001</mat-error>
            }
            @if (tieneError('numeroPatronal', 'minlength')) {
              <mat-error>M√≠nimo 10 caracteres</mat-error>
            }
            @if (tieneError('numeroPatronal', 'maxlength')) {
              <mat-error>M√°ximo 12 caracteres</mat-error>
            }
            
            <mat-hint>Formato: 01-730-00001</mat-hint>
          </mat-form-field>

          <!-- Estado de validaci√≥n -->
          <div class="validation-status" [class.valid]="preloginForm.valid" *ngIf="preloginForm.dirty">
            <mat-icon class="status-icon">
              {{ preloginForm.valid ? 'check_circle' : 'error_outline' }}
            </mat-icon>
            <span>
              @if (preloginForm.valid) {
                ‚úì Formato v√°lido
              } @else {
                Ingrese un n√∫mero patronal v√°lido
              }
            </span>
          </div>

          <!-- Botones de ejemplo -->
          <div class="ejemplos-section">
            <p class="ejemplos-label">
              <mat-icon>lightbulb</mat-icon>
              <span>Ejemplos para probar:</span>
            </p>
            <div class="ejemplos-buttons">
              @for (ejemplo of ejemplos; track ejemplo) {
                <button mat-stroked-button 
                        type="button" 
                        class="ejemplo-button"
                        (click)="cargarEjemplo(ejemplo)">
                  {{ ejemplo }}
                </button>
              }
            </div>
            <p class="ejemplo-nota">
              <small>Estos son ejemplos. Ingrese su n√∫mero patronal real.</small>
            </p>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="search-button-container">
            <button mat-raised-button 
                    color="primary"
                    class="search-button"
                    type="submit"
                    [disabled]="!botonPrincipalHabilitado">
              @if (isLoading) {
                <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
                <span>Verificando...</span>
              } @else {
                <mat-icon>
                  @if (empresaEncontrada && empresaActiva) {
                    login
                  } @else if (empresaEncontrada && !empresaActiva) {
                    block
                  } @else {
                    search
                  }
                </mat-icon>
                <span>{{ textoBotonPrincipal }}</span>
              }
            </button>

            <button mat-button 
                    type="button"
                    class="clear-button"
                    (click)="limpiar()"
                    [disabled]="isLoading">
              <mat-icon>clear_all</mat-icon>
              Limpiar
            </button>
          </div>
        </form>
      </div>

      <!-- Resultados de b√∫squeda -->
      <div class="result-section">
        <!-- Estado de carga -->
        @if (isLoading) {
          <div class="loading-state">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Buscando empresa en el sistema CNS...</p>
            <p class="loading-subtext">Esto puede tomar unos segundos</p>
          </div>
        }

        <!-- Error -->
        @if (mensajeError && busquedaRealizada && !isLoading) {
          <div class="error-result">
            <div class="result-header">
              <mat-icon class="error-icon">error_outline</mat-icon>
              <h3>No se pudo verificar la empresa</h3>
            </div>
            <p><strong>{{ mensajeError }}</strong></p>
            <div class="error-advice">
              <mat-icon>info</mat-icon>
              <p>Verifique que el n√∫mero patronal tenga el formato correcto: <strong>01-730-00001</strong></p>
            </div>
            <div class="error-actions">
              <button mat-button (click)="limpiar()">
                <mat-icon>refresh</mat-icon>
                Intentar nuevamente
              </button>
            </div>
          </div>
        }

        <!-- Empresa encontrada -->
        @if (empresaEncontrada && busquedaRealizada && !isLoading) {
          <div class="success-result">
            <div class="result-header">
              @if (empresaActiva) {
                <mat-icon class="success-icon">check_circle</mat-icon>
                <h3>¬°Empresa Verificada! ‚úì</h3>
              } @else {
                <mat-icon class="warning-icon">warning</mat-icon>
                <h3>Empresa Encontrada (Inactiva)</h3>
              }
            </div>

            <!-- Informaci√≥n principal -->
            <div class="empresa-info-primary">
              <h4>{{ empresaEncontrada.razonSocial || empresaEncontrada.RazonSocial }}</h4>
              <div class="empresa-id">
                <span class="label">N√∫mero Patronal:</span>
                <span class="value">{{ empresaEncontrada.nroPatronal || empresaEncontrada.numeroPatronal }}</span>
              </div>
            </div>

            <!-- Estado destacado -->
            <div class="estado-destacado" [class.activo]="empresaActiva" [class.inactivo]="!empresaActiva">
              <mat-icon>{{ empresaActiva ? 'check_circle' : 'block' }}</mat-icon>
              <span>
                <strong>Estado:</strong> 
                {{ empresaEncontrada.estado || empresaEncontrada.Estado || 'DESCONOCIDO' }}
              </span>
            </div>

            <!-- Detalles adicionales -->
            <div class="empresa-details-grid">
              <div class="detail-card">
                <mat-icon>fingerprint</mat-icon>
                <div class="detail-content">
                  <strong>NIT</strong>
                  <span>{{ empresaEncontrada.nit || empresaEncontrada.NIT || 'No disponible' }}</span>
                </div>
              </div>

              <div class="detail-card">
                <mat-icon>phone</mat-icon>
                <div class="detail-content">
                  <strong>Tel√©fono</strong>
                  <span>{{ empresaEncontrada.telefono || empresaEncontrada.Telefono || 'No disponible' }}</span>
                </div>
              </div>

              @if (empresaEncontrada.direccion || empresaEncontrada.Direccion) {
                <div class="detail-card">
                  <mat-icon>location_on</mat-icon>
                  <div class="detail-content">
                    <strong>Direcci√≥n</strong>
                    <span>{{ empresaEncontrada.direccion || empresaEncontrada.Direccion }}</span>
                  </div>
                </div>
              }

              @if (empresaEncontrada.fechaAfiliacion || empresaEncontrada.FechaAfiliacion) {
                <div class="detail-card">
                  <mat-icon>calendar_today</mat-icon>
                  <div class="detail-content">
                    <strong>Fecha Afiliaci√≥n</strong>
                    <span>{{ empresaEncontrada.fechaAfiliacion || empresaEncontrada.FechaAfiliacion }}</span>
                  </div>
                </div>
              }
            </div>

            <!-- Acciones seg√∫n estado -->
            @if (empresaActiva) {
              <div class="accion-activa">
                <mat-icon>arrow_forward</mat-icon>
                <div class="accion-content">
                  <p>Redirigiendo al registro de ex√°menes...</p>
                  <p class="accion-subtext">Ser√° redirigido autom√°ticamente en 3 segundos</p>
                </div>
                <button mat-raised-button 
                        color="primary"
                        (click)="redirigirAhora()">
                  <mat-icon>login</mat-icon>
                  Ingresar Ahora
                </button>
              </div>
            } @else {
              <div class="accion-inactiva">
                <mat-icon>info</mat-icon>
                <div class="accion-content">
                  <p><strong>Esta empresa no est√° activa en el sistema CNS.</strong></p>
                  <p class="accion-subtext">Contacte a la oficina de afiliaciones para regularizar su situaci√≥n.</p>
                </div>
                <button mat-stroked-button (click)="limpiar()">
                  <mat-icon>search</mat-icon>
                  Buscar otra empresa
                </button>
              </div>
            }
          </div>
        }
      </div>

      <!-- Informaci√≥n adicional -->
      <div class="info-section">
        <div class="info-card">
          <mat-icon>info</mat-icon>
          <div class="info-content">
            <h4>Informaci√≥n Importante</h4>
            <ul>
              <li>El n√∫mero patronal debe tener el formato: <strong>01-730-00001</strong></li>
              <li>Solo empresas afiliadas y activas pueden registrar ex√°menes preocupacionales</li>
              <li>Si su empresa aparece como inactiva, debe regularizar su situaci√≥n en afiliaciones</li>
              <li>Los datos de la empresa se mantendr√°n durante toda la sesi√≥n</li>
              <li>El sistema CNS verificar√° autom√°ticamente el estado de su empresa</li>
              <li>Para asistencia t√©cnica, contacte al √°rea de inform√°tica del CNS</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Debug info (opcional - solo para desarrollo) -->
      <!-- <div class="debug-panel" *ngIf="debugMode">
        <h4>üîç Informaci√≥n de Depuraci√≥n:</h4>
        <pre>Formulario v√°lido: {{ preloginForm.valid }}</pre>
        <pre>Valor: "{{ preloginForm.get('numeroPatronal')?.value }}"</pre>
        <pre>Errores: {{ preloginForm.get('numeroPatronal')?.errors | json }}</pre>
        <pre>Empresa encontrada: {{ empresaEncontrada ? 'S√≠' : 'No' }}</pre>
        <pre>Estado activo: {{ empresaActiva ? 'S√≠' : 'No' }}</pre>
        <pre>Busqueda realizada: {{ busquedaRealizada }}</pre>
        <pre>Cargando: {{ isLoading }}</pre>
      </div> -->
    </mat-card-content>

    <!-- Footer -->
    <mat-card-footer class="card-footer">
      <div class="footer-content">
        <mat-icon>verified</mat-icon>
        <div class="footer-text">
          <p>Sistema CNS - Caja Nacional de Salud ¬© 2024</p>
          <p class="footer-subtext">Versi√≥n 1.0.0 - Desarrollo</p>
        </div>
      </div>
    </mat-card-footer>
  </mat-card>
</div>