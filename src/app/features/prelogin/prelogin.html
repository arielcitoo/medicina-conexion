<!-- features/prelogin/prelogin.html -->
<div class="prelogin-container">
  <mat-card class="card-prelogin">
    
    <!-- Encabezado COMPACTADO -->
    <mat-card-header class="card-header compact-header">
      <mat-card-title>
        <div class="title-container">
          <mat-icon class="title-icon">medical_services</mat-icon>
          <div class="title-content">
            <h1>Verificación de Empresa</h1>
            <p class="subtitle">Ingrese el número patronal para verificar la afiliación al CNS</p>
          </div>
        </div>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content class="card-content">
      
      <!-- Sección de búsqueda -->
      <div class="search-section">
        <div class="section-header">
         
          <div class="section-title">
            <!-- <h2>Verificación de Empresa</h2>
            <p class="section-description">
              Ingrese el número patronal para verificar la afiliación al CNS
            </p> -->
          </div>
        </div>

        <form [formGroup]="preloginForm" (ngSubmit)="onSubmit()">
          
          <!-- Campo de número patronal -->
          <mat-form-field appearance="outline" class="full-width input-field">
            <mat-label>Número Patronal</mat-label>
            <input matInput 
                   formControlName="numeroPatronal"
                   placeholder="01-730-00001"
                   [maxlength]="12"
                   (keypress)="onKeyPress($event)"
                   (input)="onInput($event)"
                   (blur)="onBlur()">
            <mat-icon matSuffix>format_list_numbered_rtl</mat-icon>
            
            <!-- Errores de validación -->
            @if (tieneError('numeroPatronal', 'required')) {
              <mat-error>El número patronal es obligatorio</mat-error>
            }
            @if (tieneError('numeroPatronal', 'pattern')) {
              <mat-error>Formato: 01-730-00001</mat-error>
            }
            @if (tieneError('numeroPatronal', 'minlength')) {
              <mat-error>Mínimo 10 caracteres</mat-error>
            }
            @if (tieneError('numeroPatronal', 'maxlength')) {
              <mat-error>Máximo 12 caracteres</mat-error>
            }
            
            <mat-hint>Formato: 01-730-00001</mat-hint>
          </mat-form-field>

          <!-- Estado de validación -->
          @if (preloginForm.dirty) {
            <div class="validation-status" [class.valid]="preloginForm.valid">
              <mat-icon class="status-icon">
                {{ preloginForm.valid ? 'check_circle' : 'error_outline' }}
              </mat-icon>
              <span class="status-text">
                @if (preloginForm.valid) {
                  Formato válido
                } @else {
                  Formato inválido
                }
              </span>
            </div>
          }

          <!-- Botones de acción - Centrados -->
          <div class="action-buttons">
            <button mat-raised-button 
                    color="primary"
                    class="search-button"
                    type="submit"
                    [disabled]="!botonPrincipalHabilitado">
              @if (isLoading) {
                <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
                <span>Verificando...</span>
              } @else {
                <span>{{ textoBotonPrincipal }}</span>
              }
            </button>

            <button mat-button 
                    type="button"
                    class="clear-button"
                    (click)="limpiar()"
                    [disabled]="isLoading">
              <mat-icon>clear_all</mat-icon>
              Limpiar
            </button>
          </div>
        </form>
      </div>

      <!-- Resultados de búsqueda -->
      <div class="result-section">
        
        <!-- Estado de carga -->
        @if (isLoading) {
          <div class="loading-state">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Buscando empresa en el sistema CNS...</p>
          </div>
        }

        <!-- Error -->
        @if (mensajeError && busquedaRealizada && !isLoading) {
          <div class="error-result">
            <div class="result-header">
              <mat-icon class="error-icon">error_outline</mat-icon>
              <h3>No se pudo verificar la empresa</h3>
            </div>
            <p><strong>{{ mensajeError }}</strong></p>
            <div class="error-advice">
              <p>Verifique el formato: <strong>01-730-00001</strong></p>
            </div>
            <div class="error-actions">
              <button mat-button (click)="limpiar()">
                <mat-icon>refresh</mat-icon>
                Intentar nuevamente
              </button>
            </div>
          </div>
        }

        <!-- Empresa encontrada -->
        @if (empresaEncontrada && busquedaRealizada && !isLoading) {
          <div class="success-result">
            <div class="result-header">
              @if (empresaActiva) {
                   <div class="result-title">
                  <h3>¡Empresa Verificada!</h3>
                  <p class="result-subtitle">{{ empresaEncontrada.razonSocial }}</p>
                </div>
              } @else {
                <mat-icon class="warning-icon">warning</mat-icon>
                <div class="result-title">
                  <h3>Empresa Encontrada (Inactiva)</h3>
                  <p class="result-subtitle">{{ empresaEncontrada.razonSocial }}</p>
                </div>
              }
            </div>

            <!-- Información de la empresa -->
            <div class="empresa-details">
              <!-- <div class="empresa-id">
                <span class="label">Número Patronal:</span>
                <span class="value">{{ empresaEncontrada.numeroPatronal }}</span>
              </div> -->
              
              <!-- Estado destacado -->
              <div class="estado-destacado" [class.activo]="empresaActiva" [class.inactivo]="!empresaActiva">
                <mat-icon>{{ empresaActiva ? 'check_circle' : 'block' }}</mat-icon>
                <span>
                  <strong>Estado:</strong> 
                  {{ empresaEncontrada.estado || 'DESCONOCIDO' }}
                </span>
              </div>
            </div>

            <!-- Acciones según estado -->
            @if (empresaActiva) {
              <div class="accion-activa">
                <!-- Botón centrado y más destacado -->
                <button mat-raised-button 
                        color="primary"
                        class="ingresar-button"
                        (click)="redirigirAhora()"
                        [disabled]="redireccionando">
                  @if (redireccionando) {
                    <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
                    <span>Redirigiendo...</span>
                  } @else {
                    
                    <span>Ingresar Ahora</span>
                  }
                </button>
                <p class="accion-subtext">
                  Continúe al registro de exámenes preocupacionales
                </p>
              </div>
            } @else {
              <div class="accion-inactiva">
                <div class="accion-content">
                  <mat-icon>info</mat-icon>
                  <p><strong>Esta empresa no está activa en el sistema CNS.</strong></p>
                  <p class="accion-subtext">Contacte a la oficina de afiliaciones para regularizar su situación.</p>
                </div>
                <button mat-stroked-button (click)="limpiar()">
                  <mat-icon>search</mat-icon>
                  Buscar otra empresa
                </button>
              </div>
            }
          </div>
        }
      </div>

      <!-- Información adicional -->
      <div class="info-section">
        <div class="info-card">
          <div class="info-header">
            <mat-icon>info</mat-icon>
            <h4>Información Importante</h4>
          </div>
          <div class="info-content">
            <ul>
              <li>Formato requerido: <strong>01-730-00001</strong></li>
              <li>Solo empresas afiliadas y activas pueden registrar exámenes</li>
              <li>Los datos se mantendrán durante toda la sesión</li>
              <li>Sistema CNS - Versión 1.0.0</li>
            </ul>
          </div>
        </div>
      </div>
    </mat-card-content>

  </mat-card>
</div>