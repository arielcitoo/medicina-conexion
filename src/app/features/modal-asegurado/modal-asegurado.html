<div class="modal-container">
  <!-- Encabezado -->
  <div mat-dialog-title class="modal-header">
    <h2>
      <mat-icon>person_add</mat-icon>
      Registrar Asegurado
    </h2>
    <button mat-icon-button mat-dialog-close aria-label="Cerrar">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Contenido -->
  <mat-dialog-content class="modal-content">
    
    <!-- Sección de Búsqueda -->
    <div class="section">
      <div class="section-title">
        <mat-icon>search</mat-icon>
        Buscar Asegurado
      </div>
      <p class="section-description">
        Ingrese el CI y fecha de nacimiento para buscar en el sistema CNS
      </p>

      <form [formGroup]="aseguradoForm">
        <div class="form-row">
          <!-- CI -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>CI </mat-label>
            <input matInput formControlName="ci" 
                   placeholder="Ej: 1234567"
                   [maxlength]="11">
            <mat-icon matSuffix>badge</mat-icon>
            @if (aseguradoForm.get('ci')?.hasError('required')) {
              <mat-error>El CI es requerido</mat-error>
            }
            @if (aseguradoForm.get('ci')?.hasError('pattern')) {
              <mat-error>Formato inválido</mat-error>
            }
          </mat-form-field>

          <!-- Fecha de Nacimiento -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Fecha de Nacimiento </mat-label>
            <input matInput [matDatepicker]="picker" 
                   formControlName="fechaNacimiento"
                   [max]="maxFechaNacimiento()"
                   placeholder="dd/mm/aaaa">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <!-- <mat-icon matSuffix></mat-icon> -->
            @if (aseguradoForm.get('fechaNacimiento')?.hasError('required')) {
              <mat-error>La fecha es requerida</mat-error>
            }
          </mat-form-field>
        </div>

        <!-- Botón de Búsqueda -->
        <div class="search-button-container">
          <button mat-raised-button color="primary" 
                  class="search-button"
                  (click)="buscarAsegurado()"
                  [disabled]="!puedeBuscar() || isLoading">
            @if (isLoading) {
              <mat-spinner diameter="20"></mat-spinner>
              <span>Buscando...</span>
            } @else {
              <mat-icon>search</mat-icon>
              <span>Buscar Asegurado</span>
            }
          </button>
        </div>
      </form>
    </div>

    <!-- Resultados de Búsqueda -->
    <div class="result-container">
      @if (isLoading) {
        <div class="loading-state">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Consultando información del asegurado...</p>
        </div>
      }

      @if (errorBusqueda && busquedaRealizada) {
        <div class="section error-result">
          <div class="result-header">
            <mat-icon class="error-icon">error_outline</mat-icon>
            <h4>No se encontró el asegurado</h4>
          </div>
          <p>{{ errorBusqueda }}</p>
        </div>
      }

      @if (datosAsegurado && !errorBusqueda) {
        <div class="section success-result">
          <div class="result-header">
            <mat-icon class="success-icon">check_circle</mat-icon>
            <h4>Asegurado Encontrado ✓</h4>
          </div>

          <div class="result-details">
            <div class="detail-item">
              <mat-icon>person_outline</mat-icon>
              <div class="detail-content">
                <strong>Nombre Completo</strong>
                <span>{{ datosAsegurado.nombreCompleto }}</span>
              </div>
            </div>

            <div class="detail-item">
              <mat-icon>fingerprint</mat-icon>
              <div class="detail-content">
                <strong>CI</strong>
                <span>{{ datosAsegurado.ci }}</span>
              </div>
            </div>

            @if (datosAsegurado.empresa) {
              <div class="detail-item">
                <mat-icon>business</mat-icon>
                <div class="detail-content">
                  <strong>Empresa</strong>
                  <span>{{ datosAsegurado.empresa }}</span>
                </div>
              </div>
            }
          </div>

          <!-- Mensaje informativo -->
          <!-- <div class="info-message">
            <mat-icon>info</mat-icon>
            <p>Ahora complete los datos de contacto obligatorios para agregar el asegurado</p>
          </div> -->
        </div>
      }
    </div>

    <!-- Sección de Contacto (SOLO se muestra si hay datos del API) -->
  <!-- En modal-asegurado.html, modifica la sección de contacto: -->
@if (datosAsegurado && !errorBusqueda && busquedaRealizada) {
  <div class="section contact-section">
    <div class="section-title">
      <mat-icon>contact_mail</mat-icon>
      Datos de Contacto *
    </div>
    <p class="section-description">
      <strong>Complete estos datos obligatoriamente</strong> para registrar al asegurado
    </p>

    <form [formGroup]="aseguradoForm">
      <div class="form-row">
        <!-- Correo Electrónico -->
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Correo Electrónico </mat-label>
          <input matInput type="email" formControlName="correoElectronico"
                 placeholder="ejemplo@email.com"
                 (input)="validarCorreo()"
                 (blur)="validarCorreo()">
          <mat-icon matSuffix>alternate_email</mat-icon>
          
          @if (aseguradoForm.get('correoElectronico')?.hasError('required')) {
            <mat-error class="error-message">El correo es requerido</mat-error>
          }
          @if (aseguradoForm.get('correoElectronico')?.hasError('email')) {
            <mat-error class="error-message">Ingrese un correo válido</mat-error>
          }
          <mat-hint>Ej: mariarosavedia@gmail.com</mat-hint>
        </mat-form-field>

        <!-- Celular -->
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Celular </mat-label>
          <input matInput formControlName="celular"
                 placeholder="77777777"
                 [maxlength]="8"
                 (input)="validarCelular()"
                 (blur)="validarCelular()">
          <mat-icon matSuffix>smartphone</mat-icon>
          
          @if (aseguradoForm.get('celular')?.hasError('required')) {
            <mat-error class="error-message">El celular es requerido</mat-error>
          }
          @if (aseguradoForm.get('celular')?.hasError('pattern')) {
            <mat-error class="error-message">Debe tener 8 dígitos</mat-error>
          }
          <mat-hint>8 dígitos sin espacios</mat-hint>
        </mat-form-field>
      </div>
    </form>

    <!-- Estado de validación con más detalles -->
    <div class="validation-status" [class.valid]="puedeAgregar">
      @if (puedeAgregar) {
        <mat-icon class="status-icon">check_circle</mat-icon>
        <span>✓ Todos los datos están completos. Puede agregar el asegurado.</span>
      } @else {
        <mat-icon class="status-icon">error_outline</mat-icon>
        <span *ngIf="!aseguradoForm.get('correoElectronico')?.valid">
          • Correo electrónico inválido o faltante<br>
        </span>
        <span *ngIf="!aseguradoForm.get('celular')?.valid">
          • Celular debe tener 8 dígitos<br>
        </span>
      }
    </div>
  </div>
}
  </mat-dialog-content>

  <!-- Acciones -->
  <mat-dialog-actions class="modal-actions">
    <button mat-button mat-dialog-close class="cancel-button action-button">
      <mat-icon>cancel</mat-icon>
      Cancelar
    </button>
    
    <button mat-raised-button color="primary"
            class="submit-button action-button"
            [disabled]="!puedeAgregar"
            (click)="agregarAsegurado()">
      <mat-icon>person_add_alt</mat-icon>
      Agregar Asegurado
    </button>
  </mat-dialog-actions>
</div>