<h2 mat-dialog-title>
  <mat-icon>person_search</mat-icon>
  Buscar y Agregar Asegurado
</h2>

<mat-dialog-content>
  <form [formGroup]="aseguradoForm">
    
    <!-- Búsqueda de Asegurado -->
    <div class="search-section">
      <h4>Buscar Asegurado en el Sistema</h4>
      <p class="description">
        Ingrese el número de carnet de identidad y fecha de nacimiento para buscar en el sistema.
      </p>
      
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Número de Carnet de Identidad *</mat-label>
          <input matInput formControlName="ci" 
                 placeholder="Ej: 1234567LP"
                 [class.mat-input-invalid]="aseguradoForm.get('ci')?.invalid && aseguradoForm.get('ci')?.touched">
          <mat-icon matSuffix>badge</mat-icon>
          <mat-hint>Formato: 7-10 dígitos + letra opcional</mat-hint>
          @if (aseguradoForm.get('ci')?.invalid && aseguradoForm.get('ci')?.touched) {
            <mat-error>{{ ciError }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Fecha de Nacimiento *</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="fechaNacimiento"
                 [max]="maxFechaNacimiento()">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          @if (aseguradoForm.get('fechaNacimiento')?.hasError('required')) {
            <mat-error>La fecha de nacimiento es requerida</mat-error>
          }
        </mat-form-field>
      </div>

      <button mat-raised-button color="primary" 
              (click)="buscarAsegurado()"
              [disabled]="!puedeBuscar"
              class="search-button">
        @if (!isLoading) {
          <mat-icon>search</mat-icon>
          Buscar Asegurado
        } @else {
          <mat-spinner diameter="20"></mat-spinner>
          Buscando...
        }
      </button>
    </div>

    <!-- Resultado de Búsqueda -->
    @if (busquedaRealizada) {
      <div class="result-section">
        
        <!-- Resultado exitoso -->
        @if (datosAsegurado && !errorBusqueda) {
          <div class="success-result">
            <div class="result-header">
              <mat-icon class="success-icon">check_circle</mat-icon>
              <h4>Asegurado encontrado</h4>
            </div>
            
            <div class="result-details">
              <div class="detail-item">
                <mat-icon>person</mat-icon>
                <div class="detail-content">
                  <strong>Nombre Completo:</strong>
                  <span>{{ datosAsegurado!.nombreCompleto }}</span>
                </div>
              </div>
              
              <div class="detail-item">
                <mat-icon>credit_card</mat-icon>
                <div class="detail-content">
                  <strong>Documento de Identidad:</strong>
                  <span>{{ datosAsegurado!.documentoIdentidad }}</span>
                </div>
              </div>
              
              @if (datosAsegurado!.genero) {
                <div class="detail-item">
                  <mat-icon>wc</mat-icon>
                  <div class="detail-content">
                    <strong>Género:</strong>
                    <span>{{ datosAsegurado!.genero }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- Resultado con error -->
        @if (errorBusqueda) {
          <div class="error-result">
            <div class="result-header">
              <mat-icon class="error-icon">error</mat-icon>
              <h4>No se encontró el asegurado</h4>
            </div>
            <p>{{ errorBusqueda }}</p>
            <p class="suggestion">Verifique el CI y fecha de nacimiento e intente nuevamente.</p>
          </div>
        }
      </div>
    }

    <!-- Datos del Asegurado -->
    @if (datosAsegurado && !errorBusqueda) {
      <div class="data-section">
        <h4>Completar Datos del Asegurado</h4>
        <p class="description">Complete los datos obligatorios para el registro del examen:</p>
        
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Correo Electrónico *</mat-label>
            <input matInput type="email" formControlName="correoElectronico" 
                   placeholder="asegurado@email.com"
                   [class.mat-input-invalid]="aseguradoForm.get('correoElectronico')?.invalid && aseguradoForm.get('correoElectronico')?.touched">
            <mat-icon matSuffix>email</mat-icon>
            @if (aseguradoForm.get('correoElectronico')?.hasError('email')) {
              <mat-error>Ingrese un correo electrónico válido</mat-error>
            }
            @if (aseguradoForm.get('correoElectronico')?.hasError('required')) {
              <mat-error>El correo electrónico es obligatorio</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Celular *</mat-label>
            <input matInput formControlName="celular" placeholder="77777777"
                   [class.mat-input-invalid]="aseguradoForm.get('celular')?.invalid && aseguradoForm.get('celular')?.touched">
            <mat-icon matSuffix>phone</mat-icon>
            @if (aseguradoForm.get('celular')?.hasError('pattern')) {
              <mat-error>Ingrese 8 dígitos numéricos</mat-error>
            }
            @if (aseguradoForm.get('celular')?.hasError('required')) {
              <mat-error>El celular es obligatorio</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="warning-note">
          <mat-icon>info</mat-icon>
          <div>
            <p><strong>Nota importante:</strong></p>
            <p>El correo electrónico y celular son obligatorios para el registro del examen preocupacional.</p>
            <p>Si el sistema no proporcionó estos datos, debe completarlos manualmente.</p>
          </div>
        </div>
      </div>
    }

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancelar()" class="cancel-button">
    <mat-icon>close</mat-icon>
    Cancelar
  </button>
  <button mat-raised-button color="primary" 
          (click)="agregarAsegurado()"
          [disabled]="!puedeAgregar"
          class="add-button">
    <mat-icon>add</mat-icon>
    Agregar Asegurado
  </button>
</mat-dialog-actions>